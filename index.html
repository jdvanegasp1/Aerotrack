<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://i.postimg.cc/MZQg8dYX/Logo-Aerotrack.jpg" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <title>Aerotrack - Aviation & Motorsport Social Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .message-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: linear-gradient(45deg, #e53935, #c62828);
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    animation: pulse 2s infinite;
}
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
     


.nav-buttons {
    display: flex !important;
    gap: 10px;
    align-items: center;
}

        
        .header-content {
            display: flex;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: space-between;
        }
        
        .logo {
    display: flex;
    align-items: center;
    gap: 10px;
}

.logo img {
    height: 40px;
    width: auto;
    border-radius: 6px;
}

.logo-text {
    font-size: 28px;
    font-weight: bold;
    color: #1e3c72;
}
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-container {
            position: relative;
            margin: 0 15px;
        }
        
        .search-input {
            padding: 8px 35px 8px 15px;
            border: 2px solid #ddd;
            border-radius: 20px;
            outline: none;
            width: 250px;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            border-color: #1e3c72;
            width: 300px;
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            cursor: pointer;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .search-results.show {
            display: block;
        }
        
        .search-section-title {
            font-weight: bold;
            color: #1e3c72;
            padding: 8px 10px;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            margin: 5px;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: #f0f0f0;
        }
        
        .search-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .search-user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #1e3c72);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            background-size: cover;
            background-position: center;
        }
        
        .search-user-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        .search-user-bio {
            font-size: 11px;
            color: #666;
        }

        .message-btn {
            background: linear-gradient(45deg, #2196f3, #42a5f5);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
            transition: transform 0.2s;
        }

        .message-btn:hover {
            transform: translateY(-2px);
        }

        .contacts-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.2s;
        }

        .contact-item:hover {
            background: white;
        }

        .contact-item.active {
            background: #e3f2fd;
        }

        .contact-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #1e3c72);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            background-size: cover;
            background-position: center;
        }

        .contact-name {
            font-weight: bold;
            font-size: 14px;
            color: #1e3c72;
        }

        .chat-area {
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-messages {
            flex: 1;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .message.sent {
            align-items: flex-end;
        }

        .message.received {
            align-items: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            word-wrap: break-word;
        }

        .message.sent .message-content {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
        }

        .message.received .message-content {
            background: #f8f9fa;
            color: #333;
        }

        .message-time {
            font-size: 10px;
            color: #999;
            margin-top: 3px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            outline: none;
        }

        .send-btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .nav-btn {
    display: inline-block !important;
    padding: 8px 16px;
    border: none;
    border-radius: 20px;
    background: linear-gradient(45deg, #ff6b35, #f7931e);
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.2s;
}
        
        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            border-radius: 20px;
            background: white;
            color: #666;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .filter-btn:hover {
            border-color: #1e3c72;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        
        .main-feed {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.1);
        }
        
        .post-composer {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .post-input {
            width: 100%;
            border: 2px solid #ddd;
            background: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            min-height: 80px;
            font-family: inherit;
            outline: none;
        }
        
        .post-btn {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .post-composer-bottom {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .category-selector {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            border: 2px solid #ddd;
            gap: 5px;
        }

        .category-option {
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            transition: all 0.2s;
        }

        .category-option.active {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }

        .image-upload-btn {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 8px 16px;
            cursor: pointer;
            color: #2196f3;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .image-upload-btn:hover {
            background: #2196f3;
            color: white;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
            display: none;
        }

        .post-image {
            max-width: 100%;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .posts {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .post {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
            border-left: 4px solid #1e3c72;
        }

        .post.repost {
            border-left-color: #4caf50;
        }

        .repost-info {
            background: #f0f8f0;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            color: #4caf50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #1e3c72);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            background-size: cover;
            background-position: center;
        }
        
        .post-info h4 {
            font-weight: bold;
            cursor: pointer;
            color: #1e3c72;
        }
        
        .post-time {
            color: #666;
            font-size: 12px;
        }
        
        .post-content {
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .post-actions {
            display: flex;
            gap: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            color: #1e3c72;
        }

        .action-btn.liked {
            color: #e74c3c;
        }

        .action-btn.reposted {
            color: #4caf50;
        }

        .comments-section {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-input input {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 8px 15px;
            outline: none;
            font-size: 14px;
        }

        .comment-input button {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            border-radius: 15px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: bold;
        }

        .comment {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #1e3c72);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 10px;
            background-size: cover;
            background-position: center;
        }

        .comment-author {
            font-weight: bold;
            color: #1e3c72;
            font-size: 12px;
        }

        .comment-time {
            color: #999;
            font-size: 11px;
        }

        .comment-content {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .comment-actions {
            display: flex;
            gap: 15px;
        }

        .comment-action {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 12px;
            transition: color 0.2s;
        }

        .comment-action:hover {
            color: #1e3c72;
        }

        .comment-action.liked {
            color: #e74c3c;
        }
.delete-btn {
    background: none;
    border: none;
    color: #e53935;
    cursor: pointer;
    font-size: 12px;
    transition: color 0.2s;
    margin-left: auto;
}

.delete-btn:hover {
    color: #c62828;
}

.post-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
    position: relative;
}

.post-header .delete-btn {
    position: absolute;
    right: 0;
    font-size: 14px;
}
        .reply-form {
            margin-top: 10px;
            display: none;
        }

        .reply-form.show {
            display: flex;
            gap: 8px;
        }

        .reply-form input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 6px 12px;
            outline: none;
            font-size: 12px;
        }

        .reply-form button {
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
        }

        .replies {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .widget {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.1);
        }
        
        .widget h3 {
            margin-bottom: 15px;
            color: #1e3c72;
        }
        
        .event {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .event:hover {
            background: #e3f2fd;
        }
        
        .event-title {
            font-weight: bold;
            font-size: 14px;
        }
        
        .event-time {
            color: #666;
            font-size: 12px;
        }
        
        .trend-item {
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 14px;
            color: #1e3c72;
            font-weight: bold;
            margin-bottom: 8px;
            cursor: pointer;
        }
        
        .trend-item:hover {
            background: #e3f2fd;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
        }
        
        .close-btn:hover {
            background: #f0f0f0;
        }

    .auth-container {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
    background-image: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%) !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    z-index: 3000 !important;
}

.auth-container::before {
    display: none !important;
}

        .auth-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .auth-logo {
    text-align: center;
    margin-bottom: 20px;
}

.auth-logo img {
    width: 85%;
    max-width: 300px;
    height: auto;
    border-radius: 12px;
}

        .auth-title {
    text-align: center;
    font-size: 48px;
    font-weight: bold;
    color: #1e3c72;
    margin-bottom: 30px;
    letter-spacing: 2px;
}

        .auth-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            border-color: #1e3c72;
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            color: white;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
        }

        .auth-switch {
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .auth-switch a {
            color: #1e3c72;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .settings-section h4 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .setting-item {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .profile-pic-container {
            text-align: center;
            margin-bottom: 20px;
        }

        .profile-pic-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b35, #1e3c72);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 42px;
            margin-bottom: 15px;
            position: relative;
            background-size: cover;
            background-position: center;
        }

        .follow-btn {
            width: auto;
            padding: 10px 30px;
            margin: 15px 0;
            background: linear-gradient(45deg, #ff6b35, #f7931e);
            transition: all 0.3s;
        }

        .follow-btn.following {
            background: linear-gradient(45deg, #4caf50, #66bb6a);
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            transform: translateX(400px);
            transition: transform 0.3s ease-out;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        
        .notification.show {
            transform: translateX(0);
        }

        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
            }
            
            .sidebar {
                display: none;
            }

            .logo {
                font-size: 20px;
            }

            .search-input {
                width: 150px;
            }

            .search-input:focus {
                width: 200px;
            }

            .nav-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}
        }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">
    <img src="https://i.postimg.cc/MZQg8dYX/Logo-Aerotrack.jpg" alt="Aerotrack Logo">
</div>
            <h1 class="auth-title">Aerotrack</h1>
            
            <div id="loginForm">
                <div class="auth-error" id="loginError"></div>
                <input type="text" class="auth-input" id="loginUsername" placeholder="Username">
                <input type="password" class="auth-input" id="loginPassword" placeholder="Password">
                <button class="auth-btn" onclick="login()">Log In</button>
                <button class="auth-btn" onclick="continueAsGuest()" style="background: linear-gradient(45deg, #666, #888); margin-bottom: 10px;">Continue as Guest</button>
                <div class="auth-switch">
                    Don't have an account? <a onclick="showSignup()">Sign up</a>
                </div>
            </div>

            <div id="signupForm" class="hidden">
                <div class="auth-error" id="signupError"></div>
                <input type="text" class="auth-input" id="signupUsername" placeholder="Username">
                <input type="email" class="auth-input" id="signupEmail" placeholder="Email">
                <input type="password" class="auth-input" id="signupPassword" placeholder="Password">
                <input type="password" class="auth-input" id="signupConfirmPassword" placeholder="Confirm Password">
                <textarea class="auth-input" id="signupBio" placeholder="Tell us about yourself... (optional)" style="min-height: 60px; resize: vertical;"></textarea>
                <button class="auth-btn" onclick="signup()">Sign Up</button>
                <div class="auth-switch">
                    Already have an account? <a onclick="showLogin()">Log in</a>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <header class="header">
            <div class="header-content">
                <div class="logo">
    <img src="https://i.postimg.cc/MZQg8dYX/Logo-Aerotrack.jpg" alt="Aerotrack Logo">
    <span class="logo-text">Aerotrack</span>
</div>

                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search users, posts..." oninput="performSearch(this.value)">
                    <span class="search-icon">üîç</span>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="nav-buttons">
    <button class="nav-btn" onclick="openMessages()" style="position: relative;">Messages<span class="message-badge hidden" id="messageBadge">0</span></button>
    <button class="nav-btn" onclick="openProfile()">Profile</button>
    <button class="nav-btn" onclick="openSettings()">Settings</button>
    <button class="nav-btn" onclick="logout()" style="background: #e53935;" id="logoutBtn">Logout</button>
</div>
    <span class="message-badge hidden" id="messageBadge">0</span>
</button>
                </div>
            </div>
        </header>

        <div class="container">
            <main class="main-feed">
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="setFilter('all')">üåê All Posts</button>
                    <button class="filter-btn" onclick="setFilter('aviation')">‚úàÔ∏è Aviation</button>
                    <button class="filter-btn" onclick="setFilter('motorsport')">üèéÔ∏è Motorsport</button>
                </div>
                
                <div class="post-composer">
                    <textarea class="post-input" id="postInput" placeholder="Share your aviation or motorsport experience..."></textarea>
                    <img class="image-preview" id="imagePreview" alt="Preview">
                    <div class="post-composer-bottom">
                        <div class="category-selector">
                            <button class="category-option active" data-category="general" onclick="selectCategory(this)">üåê General</button>
                            <button class="category-option" data-category="aviation" onclick="selectCategory(this)">‚úàÔ∏è Aviation</button>
                            <button class="category-option" data-category="motorsport" onclick="selectCategory(this)">üèéÔ∏è Motorsport</button>
                        </div>
                        <label class="image-upload-btn">
                            üì∑ Add Photo
                            <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="previewImage(this)">
                        </label>
                        <button class="post-btn" onclick="createPost()">Post</button>
                    </div>
                </div>

                <div class="posts" id="postsContainer"></div>
            </main>

            <aside class="sidebar">
                <div class="widget">
                    <h3>üî¥ Live Events</h3>
                    <div class="event" onclick="openLiveEvent('singapore-gp')">
                        <div class="event-title">Singapore GP Practice 2</div>
                        <div class="event-time">Live now ‚Ä¢ Formula 1</div>
                    </div>
                    <div class="event" onclick="openLiveEvent('oshkosh-airventure')">
                        <div class="event-title">Oshkosh AirVenture</div>
                        <div class="event-time">Today ‚Ä¢ Aviation</div>
                    </div>
                    <div class="event" onclick="openLiveEvent('lemans-24h')">
                        <div class="event-title">Le Mans 24 Hours</div>
                        <div class="event-time">Tomorrow ‚Ä¢ Endurance Racing</div>
                    </div>
                </div>

                <div class="widget">
                    <h3>üìà Trending Topics</h3>
                    <div class="trend-item" onclick="openTrendingTopic('F1Singapore')">#F1Singapore</div>
                    <div class="trend-item" onclick="openTrendingTopic('Boeing737MAX')">#Boeing737MAX</div>
                    <div class="trend-item" onclick="openTrendingTopic('WEC2025')">#WEC2025</div>
                    <div class="trend-item" onclick="openTrendingTopic('AirbusA350')">#AirbusA350</div>
                    <div class="trend-item" onclick="openTrendingTopic('FormulaE')">#FormulaE</div>
                </div>
            </aside>
        </div>
    </div>

    <div class="modal" id="profileModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Profile</h2>
                <button class="close-btn" onclick="closeModal('profileModal')">√ó</button>
            </div>
            <div id="profileContent"></div>
        </div>
    </div>

    <div class="modal" id="messagesModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Messages</h2>
                <button class="close-btn" onclick="closeModal('messagesModal')">√ó</button>
            </div>
            <div class="contacts-list" id="contactsList"></div>
            <div class="chat-area" id="chatArea" style="display: none;">
                <div class="chat-header" id="chatHeader"></div>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">√ó</button>
            </div>
            <div id="settingsContent"></div>
        </div>
    </div>

    <div class="notification" id="notification" onclick="dismissNotification()"></div>

    <script> 
    // Supabase Configuration
const SUPABASE_URL = 'https://ddsdwaqpgouftmmzwtkp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkc2R3YXFwZ291ZnRtbXp3dGtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDgxNDMsImV4cCI6MjA3NDcyNDE0M30.r5HwHy791-T4okb0DMNv8RJitO0CBZV3aeQ9vo4QzSQ';

// Initialize Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Database helper functions

const db = {
    
    
    async createUser(userData) {
        const { data, error } = await supabase
            .from('users')
            .insert([{
                username: userData.username,
                email: userData.email,
                password: userData.password,
                bio: userData.bio || 'New Aerotrack member',
                followers: 0,
                profile_pic: null
            }])
            .select()
            .single();
        
        if (error) throw error;
        return data;
    },
    

    async getUserByUsername(username) {
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('username', username)
            .single();
        
        if (error && error.code !== 'PGRST116') throw error;
        return data;
    },

    async getAllUsers() {
        const { data, error } = await supabase
            .from('users')
            .select('*');
        
        if (error) throw error;
        return data || [];
    },

    async updateUser(userId, updates) {
        const { data, error } = await supabase
            .from('users')
            .update(updates)
            .eq('id', userId)
            .select()
            .single();
        
        if (error) throw error;
        return data;
    },

    async createPost(postData) {
        const { data, error } = await supabase
            .from('posts')
            .insert([{
                author: postData.author,
                content: postData.content,
                category: postData.category,
                likes: 0,
                image: postData.image,
                is_repost: postData.isRepost || false,
                original_author: postData.originalAuthor
            }])
            .select()
            .single();
        
        if (error) throw error;
        return data;
    },

    async getAllPosts() {
        const { data, error } = await supabase
            .from('posts')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
    },

    async updatePostLikes(postId, likes) {
        const { data, error } = await supabase
            .from('posts')
            .update({ likes })
            .eq('id', postId);
        
        if (error) throw error;
        return data;
    },

    async createComment(commentData) {
        const { data, error } = await supabase
            .from('comments')
            .insert([{
                post_id: commentData.postId,
                author: commentData.author,
                content: commentData.content,
                likes: 0,
                parent_comment_id: commentData.parentCommentId || null
            }])
            .select()
            .single();
        
        if (error) throw error;
        return data;
    },

    async getCommentsByPostId(postId) {
        const { data, error } = await supabase
            .from('comments')
            .select('*')
            .eq('post_id', postId)
            .order('created_at', { ascending: true });
        
        if (error) throw error;
        return data || [];
    },

    async followUser(followerId, followingId) {
        const { data, error } = await supabase
            .from('follows')
            .insert([{
                follower_id: followerId,
                following_id: followingId
            }]);
        
        if (error) throw error;
        return data;
    },

    async unfollowUser(followerId, followingId) {
        const { data, error } = await supabase
            .from('follows')
            .delete()
            .eq('follower_id', followerId)
            .eq('following_id', followingId);
        
        if (error) throw error;
        return data;
    },

    async getFollowing(userId) {
        const { data, error } = await supabase
            .from('follows')
            .select('following_id')
            .eq('follower_id', userId);
        
        if (error) throw error;
        return data || [];
    },

    async sendMessage(messageData) {
        const { data, error } = await supabase
            .from('messages')
            .insert([{
                sender_id: messageData.senderId,
                receiver_id: messageData.receiverId,
                content: messageData.content
            }])
            .select()
            .single();
        
        if (error) throw error;
        return data;
    },

    async getMessages(userId1, userId2) {
        const { data, error } = await supabase
            .from('messages')
            .select('*')
            .or(`and(sender_id.eq.${userId1},receiver_id.eq.${userId2}),and(sender_id.eq.${userId2},receiver_id.eq.${userId1})`)
            .order('created_at', { ascending: true });
        
        if (error) throw error;
        return data || [];
    },

    async toggleLike(userId, postId) {
        const { data: existing } = await supabase
            .from('likes')
            .select('*')
            .eq('user_id', userId)
            .eq('post_id', postId)
            .single();
        
        if (existing) {
            const { error } = await supabase
                .from('likes')
                .delete()
                .eq('user_id', userId)
                .eq('post_id', postId);
            
            if (error) throw error;
            return false;
        } else {
            const { error } = await supabase
                .from('likes')
                .insert([{ user_id: userId, post_id: postId }]);
            
            if (error) throw error;
            return true;
        }
    },

    async getUserLikes(userId) {
        const { data, error } = await supabase
            .from('likes')
            .select('post_id')
            .eq('user_id', userId);
        
        if (error) throw error;
        return data || [];
    },
    async updateLastSeen(userId) {
    const { error } = await supabase
        .from('users')
        .update({ last_seen: new Date().toISOString() })
        .eq('id', userId);
    
    if (error) console.error('Error updating last seen:', error);
},

async getUserLastSeen(username) {
    const { data, error } = await supabase
        .from('users')
        .select('last_seen')
        .eq('username', username)
        .single();
    
    if (error) return null;
    return data?.last_seen;
}
    
};
// Polling interval for database updates
// Polling system for automatic updates
let pollingInterval = null;

async function pollDatabaseForUpdates() {
    if (!appData.currentUser) return;
    
    try {
        console.log('üîÑ Checking database for updates...');
        
        // Save current scroll position
        const postsContainer = document.getElementById('postsContainer');
        const chatMessages = document.getElementById('chatMessages');
        const postsScroll = postsContainer ? postsContainer.scrollTop : 0;
        const chatScroll = chatMessages ? chatMessages.scrollTop : 0;
        
        // Get current message count for notification check
        const oldMessageCount = appData.currentChat && appData.messages[appData.currentUser.username]?.[appData.currentChat] 
            ? appData.messages[appData.currentUser.username][appData.currentChat].length 
            : 0;
        
        // Load new data
        await loadDataFromDatabase();
        
        // Check for new messages and show notifications
        if (appData.currentChat && appData.messages[appData.currentUser.username]?.[appData.currentChat]) {
            const newMessageCount = appData.messages[appData.currentUser.username][appData.currentChat].length;
            if (newMessageCount > oldMessageCount) {
                const newMessages = appData.messages[appData.currentUser.username][appData.currentChat].slice(oldMessageCount);
                newMessages.forEach(msg => {
                    if (msg.sender !== appData.currentUser.username) {
                        showNotification(`üí¨ New message from ${msg.sender}`, 4000);
                    }
                });
                
                // Update chat if open
                if (document.getElementById('chatArea').style.display === 'flex') {
                    renderChatMessages();
                }
            }
        }
        
        // Check for messages from other users
        if (!appData.currentUser.isGuest) {
            await checkForNewMessages();
        }
        
        // Restore scroll positions
        if (postsContainer) {
            postsContainer.scrollTop = postsScroll;
        }
        if (chatMessages && document.getElementById('chatArea').style.display === 'flex') {
            // Only scroll to bottom if user was already at bottom (viewing latest messages)
            const wasAtBottom = chatScroll >= chatMessages.scrollHeight - chatMessages.clientHeight - 50;
            if (wasAtBottom) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                chatMessages.scrollTop = chatScroll; // Keep current position
            }
        }
        
        console.log('‚úÖ Database updated successfully');
    } catch (error) {
        console.error('‚ùå Error polling database:', error);
    }
}
async function checkForNewMessages() {
    if (!appData.currentUser || appData.currentUser.isGuest) return;
    
    try {
        // Get all messages where current user is receiver
        const { data: newMessages, error } = await supabase
            .from('messages')
            .select('*, sender:users!messages_sender_id_fkey(username)')
            .eq('receiver_id', appData.currentUser.id)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (error) throw error;
        
        if (newMessages && newMessages.length > 0) {
            // Check for unread messages from each sender
            newMessages.forEach(msg => {
                const senderUsername = msg.sender.username;
                
                // Initialize message storage if needed
                if (!appData.messages[appData.currentUser.username]) {
                    appData.messages[appData.currentUser.username] = {};
                }
                if (!appData.messages[appData.currentUser.username][senderUsername]) {
                    appData.messages[appData.currentUser.username][senderUsername] = [];
                }
                
                // Check if this message is already in our local storage
                const messageExists = appData.messages[appData.currentUser.username][senderUsername].some(
                    m => m.time === formatTimeAgo(msg.created_at) && m.content === msg.content
                );
                
                // If it's a new message and not from current open chat, show notification
                if (!messageExists && appData.currentChat !== senderUsername) {
                    showNotification(`üí¨ New message from ${senderUsername}: ${msg.content.substring(0, 30)}${msg.content.length > 30 ? '...' : ''}`, 5000);
                }
            });
        }
    } catch (error) {
        console.error('Error checking for new messages:', error);
    }
}

function updateMessageBadge() {
    if (!appData.currentUser || appData.currentUser.isGuest) return;
    
    const badge = document.getElementById('messageBadge');
    if (!badge) return;
    
    let unreadCount = 0;
    
    // Count messages from users other than current chat
    Object.keys(appData.messages[appData.currentUser.username] || {}).forEach(username => {
        if (username !== appData.currentChat) {
            const messages = appData.messages[appData.currentUser.username][username];
            // Count messages from others (simple approach - shows all messages from non-active chats)
            const fromOthers = messages.filter(m => m.sender !== appData.currentUser.username);
            unreadCount += fromOthers.length;
        }
    });
    
    if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}


function startDatabasePolling() {
    // Stop any existing polling
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    // Start polling every 5 seconds
    pollingInterval = setInterval(pollDatabaseForUpdates, 5000);
    console.log('‚úÖ Automatic refresh started - checking every 5 seconds');
    
    // Do immediate check
    pollDatabaseForUpdates();
}

function stopDatabasePolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('‚èπÔ∏è Automatic refresh stopped');
    }
}


// Real-time subscriptions


function setupRealtimeSubscriptions() {
    // Unsubscribe from existing subscriptions
    if (postsSubscription) supabase.removeChannel(postsSubscription);
    if (commentsSubscription) supabase.removeChannel(commentsSubscription);
    if (likesSubscription) supabase.removeChannel(likesSubscription);

    // Subscribe to posts changes
    postsSubscription = supabase
        .channel('posts-channel')
        .on('postgres_changes', 
            { event: '*', schema: 'public', table: 'posts' },
            async (payload) => {
                console.log('Posts change detected:', payload);
                await loadDataFromDatabase();
            }
        )
        .subscribe();

    // Subscribe to comments changes
    commentsSubscription = supabase
        .channel('comments-channel')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'comments' },
            async (payload) => {
                console.log('Comments change detected:', payload);
                await loadDataFromDatabase();
            }
        )
        .subscribe();

    // Subscribe to likes changes
    likesSubscription = supabase
        .channel('likes-channel')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'likes' },
            async (payload) => {
                console.log('Likes change detected:', payload);
                await loadDataFromDatabase();
            }
        )
        .subscribe();

    // Subscribe to follows changes
    const followsSubscription = supabase
        .channel('follows-channel')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'follows' },
            async (payload) => {
                console.log('Follows change detected:', payload);
                await loadDataFromDatabase();
            }
        )
        .subscribe();

    // Subscribe to users changes
    const usersSubscription = supabase
        .channel('users-channel')
        .on('postgres_changes',
            { event: 'UPDATE', schema: 'public', table: 'users' },
            async (payload) => {
                console.log('Users change detected:', payload);
                await loadDataFromDatabase();
            }
        )
        .subscribe();
}

function cleanupRealtimeSubscriptions() {
    if (postsSubscription) supabase.removeChannel(postsSubscription);
    if (commentsSubscription) supabase.removeChannel(commentsSubscription);
    if (likesSubscription) supabase.removeChannel(likesSubscription);
    
}
function updateUserActivity() {
    if (appData.currentUser && !appData.currentUser.isGuest) {
        db.updateLastSeen(appData.currentUser.id);
    }
}

// Update activity every 30 seconds
let activityInterval = null;

function startActivityTracking() {
    if (activityInterval) clearInterval(activityInterval);
    
    // Update immediately
    updateUserActivity();
    
    // Then update every 30 seconds
    activityInterval = setInterval(updateUserActivity, 30000);
    
    // Also update on any user interaction
    document.addEventListener('click', updateUserActivity);
    document.addEventListener('keypress', updateUserActivity);
}

function stopActivityTracking() {
    if (activityInterval) {
        clearInterval(activityInterval);
        activityInterval = null;
    }
    document.removeEventListener('click', updateUserActivity);
    document.removeEventListener('keypress', updateUserActivity);
}
function isUserOnline(lastSeen) {
    if (!lastSeen) return false;
    const lastSeenDate = new Date(lastSeen);
    const now = new Date();
    const diffMinutes = (now - lastSeenDate) / 1000 / 60;
    return diffMinutes < 3; // Online if active within last 3 minutes
}

function getOnlineStatus(lastSeen) {
    if (!lastSeen) return { status: 'offline', text: 'Offline', color: '#999' };
    
    const lastSeenDate = new Date(lastSeen);
    const now = new Date();
    const diffMinutes = (now - lastSeenDate) / 1000 / 60;
    
    if (diffMinutes < 3) {
        return { status: 'online', text: 'Online', color: '#4caf50' };
    } else if (diffMinutes < 10) {
        return { status: 'away', text: 'Away', color: '#ff9800' };
    } else {
        const hours = Math.floor(diffMinutes / 60);
        const days = Math.floor(hours / 24);
        
        if (days > 0) {
            return { status: 'offline', text: `Last seen ${days}d ago`, color: '#999' };
        } else if (hours > 0) {
            return { status: 'offline', text: `Last seen ${hours}h ago`, color: '#999' };
        } else {
            return { status: 'offline', text: `Last seen ${Math.floor(diffMinutes)}m ago`, color: '#999' };
        }
    }
}
async function loadDataFromDatabase() {
    try {
        const users = await db.getAllUsers();
        appData.users = users.map(u => ({
            id: u.id,
            username: u.username,
            email: u.email,
            password: u.password,
            bio: u.bio,
            followers: u.followers,
            profilePic: u.profile_pic
        }));

        const posts = await db.getAllPosts();
        appData.posts = posts.map(p => ({
            id: p.id,
            author: p.author,
            content: p.content,
            category: p.category,
            likes: p.likes,
            time: formatTimeAgo(p.created_at),
            image: p.image,
            isRepost: p.is_repost,
            originalAuthor: p.original_author
        }));

        if (appData.currentUser && !appData.currentUser.isGuest) {
            const likes = await db.getUserLikes(appData.currentUser.id);
            appData.likes[appData.currentUser.username] = likes.map(l => l.post_id);
        }

        if (appData.currentUser && !appData.currentUser.isGuest) {
            const following = await db.getFollowing(appData.currentUser.id);
            appData.following[appData.currentUser.username] = following.map(f => {
                const user = appData.users.find(u => u.id === f.following_id);
                return user ? user.username : null;
            }).filter(Boolean);
        }
        // Load repost tracking
if (appData.currentUser && !appData.currentUser.isGuest) {
    appData.reposts[appData.currentUser.username] = [];
    posts.forEach(post => {
        if (post.is_repost && post.author === appData.currentUser.username && post.original_author) {
            // Find original post ID (this is approximate tracking)
            const originalPost = posts.find(p => 
                p.author === post.original_author && 
                p.content === post.content && 
                !p.is_repost
            );
            if (originalPost) {
                appData.reposts[appData.currentUser.username].push(originalPost.id);
            }
        }
    });
}

        for (const post of appData.posts) {
            const comments = await db.getCommentsByPostId(post.id);
            appData.comments[post.id] = comments.map(c => ({
                id: c.id,
                postId: c.post_id,
                author: c.author,
                content: c.content,
                time: formatTimeAgo(c.created_at),
                likes: c.likes,
                replies: comments.filter(r => r.parent_comment_id === c.id).map(r => ({
                    id: r.id,
                    author: r.author,
                    content: r.content,
                    time: formatTimeAgo(r.created_at),
                    likes: r.likes
                }))
            })).filter(c => !c.parent_comment_id);
        }
// Load messages for current user - IMPROVED VERSION
        if (appData.currentUser && !appData.currentUser.isGuest) {
            const { data: sentMessages } = await supabase
                .from('messages')
                .select('*, receiver:users!messages_receiver_id_fkey(username)')
                .eq('sender_id', appData.currentUser.id);
            
            const { data: receivedMessages } = await supabase
                .from('messages')
                .select('*, sender:users!messages_sender_id_fkey(username)')
                .eq('receiver_id', appData.currentUser.id);
            
            // Initialize messages structure
            if (!appData.messages[appData.currentUser.username]) {
                appData.messages[appData.currentUser.username] = {};
            }
            
            // Create a temporary storage for all messages with unique IDs
            const allMessages = {};
            
            // Process sent messages
            if (sentMessages) {
                sentMessages.forEach(msg => {
                    const otherUser = msg.receiver.username;
                    if (!allMessages[otherUser]) allMessages[otherUser] = [];
                    
                    allMessages[otherUser].push({
                        id: msg.id, // Use database ID for uniqueness
                        sender: appData.currentUser.username,
                        content: msg.content,
                        time: formatTimeAgo(msg.created_at),
                        timestamp: new Date(msg.created_at).getTime()
                    });
                });
            }
            
            // Process received messages
            if (receivedMessages) {
                receivedMessages.forEach(msg => {
                    const otherUser = msg.sender.username;
                    if (!allMessages[otherUser]) allMessages[otherUser] = [];
                    
                    allMessages[otherUser].push({
                        id: msg.id, // Use database ID for uniqueness
                        sender: otherUser,
                        content: msg.content,
                        time: formatTimeAgo(msg.created_at),
                        timestamp: new Date(msg.created_at).getTime()
                    });
                });
            }
            
            // Sort and deduplicate messages for each conversation
            Object.keys(allMessages).forEach(user => {
                // Remove duplicates based on ID
                const uniqueMessages = Array.from(
                    new Map(allMessages[user].map(msg => [msg.id, msg])).values()
                );
                
                // Sort by timestamp
                uniqueMessages.sort((a, b) => a.timestamp - b.timestamp);
                
                // Update appData only if different
                appData.messages[appData.currentUser.username][user] = uniqueMessages;
            });
        }
        renderPosts();
    } catch (error) {
        console.error('Error loading data:', error);
        showNotification('Error loading data from database');
    }
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
    return Math.floor(seconds / 86400) + ' days ago';
}
        let appData = {
            users: [],
            posts: [],
            comments: {},
            likes: {},
            commentLikes: {},
            reposts: {},
            currentUser: null,
            currentFilter: 'all',
            selectedCategory: 'general',
            currentImage: null,
            following: {},
            messages: {},
            currentChat: null,
            
            nextCommentId: 1,
            nextPostId: 1,
            openComments: new Set(), // Track which comment sections are open
            openReplyForms: new Set() // Track which reply forms are open
        };

        

function initSampleData() {
    appData.users = [
        { id: 1, username: 'pilot_sarah', email: 'sarah@example.com', password: 'password', bio: 'Commercial pilot ‚Ä¢ Boeing 737 enthusiast', followers: 156, profilePic: null },
        { id: 2, username: 'racing_mike', email: 'mike@example.com', password: 'password', bio: 'F1 fanatic ‚Ä¢ Track day warrior', followers: 243, profilePic: null },
        { id: 3, username: 'avgeek_alex', email: 'alex@example.com', password: 'password', bio: 'Aviation photographer ‚Ä¢ A380 lover', followers: 312, profilePic: null }
    ];

    appData.posts = [
        { id: 1, author: 'pilot_sarah', content: 'Just completed my first landing at Kai Tak! The approach was absolutely breathtaking. Anyone else miss this legendary airport?', category: 'aviation', likes: 42, time: '2 hours ago', image: null, isRepost: false, originalAuthor: null },
        { id: 2, author: 'racing_mike', content: 'Singapore GP qualifying was incredible! That lap from Verstappen was pure perfection. Who are you rooting for tomorrow?', category: 'motorsport', likes: 38, time: '4 hours ago', image: null, isRepost: false, originalAuthor: null },
        { id: 3, author: 'avgeek_alex', content: 'Spotted an A350 in the new livery today. The design is absolutely stunning! Aviation never ceases to amaze me.', category: 'aviation', likes: 56, time: '1 day ago', image: null, isRepost: false, originalAuthor: null }
    ];

    appData.nextPostId = 4;
}
       function continueAsGuest() {
    const guestUser = {
        id: 999,
        username: 'Guest',
        email: 'guest@aerotrack.com',
        password: '',
        bio: 'Browsing as Guest',
        followers: 0,
        profilePic: null,
        isGuest: true
    };

    appData.currentUser = guestUser;
    
    document.getElementById('authContainer').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('logoutBtn').textContent = 'Exit Guest Mode';
    showNotification('Welcome, Guest!', 2000);
    renderPosts();
    startDatabasePolling();
    startActivityTracking(); // ADD THIS LINE after setting currentUser // CAMBIA setupRealtimeSubscriptions() por esto
}

        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.getElementById('loginError').style.display = 'none';
        }

        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupError').style.display = 'none';
        }

        async function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    const errorEl = document.getElementById('loginError');

    if (!username || !password) {
        errorEl.textContent = 'Please enter both username and password';
        errorEl.style.display = 'block';
        return;
    }

    try {
        const user = await db.getUserByUsername(username);
        
        if (user && user.password === password) {
            appData.currentUser = {
                id: user.id,
                username: user.username,
                email: user.email,
                password: user.password,
                bio: user.bio,
                followers: user.followers,
                profilePic: user.profile_pic
            };
            
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            showNotification('Welcome back, ' + user.username + '!');
            
            await loadDataFromDatabase();
            startActivityTracking();
             startDatabasePolling()
        } else {
            errorEl.textContent = 'Invalid username or password';
            errorEl.style.display = 'block';
        }
    } catch (error) {
        console.error('Login error:', error);
        errorEl.textContent = 'Error logging in. Please try again.';
        errorEl.style.display = 'block';
    }
}

        async function signup() {
    const username = document.getElementById('signupUsername').value.trim();
    const email = document.getElementById('signupEmail').value.trim();
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('signupConfirmPassword').value;
    const bio = document.getElementById('signupBio').value.trim();
    const errorEl = document.getElementById('signupError');

    if (!username || !email || !password || !confirmPassword) {
        errorEl.textContent = 'Please fill in all required fields';
        errorEl.style.display = 'block';
        return;
    }

    if (password !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.style.display = 'block';
        return;
    }

    try {
        const existingUser = await db.getUserByUsername(username);
        if (existingUser) {
            errorEl.textContent = 'Username already exists';
            errorEl.style.display = 'block';
            return;
        }

        const newUser = await db.createUser({
            username,
            email,
            password,
            bio: bio || 'New Aerotrack member'
        });

        appData.currentUser = {
            id: newUser.id,
            username: newUser.username,
            email: newUser.email,
            password: newUser.password,
            bio: newUser.bio,
            followers: newUser.followers,
            profilePic: newUser.profile_pic
        };

        appData.users.push(appData.currentUser);
        
        document.getElementById('authContainer').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        showNotification('Welcome to Aerotrack, ' + username + '!');
        
        await loadDataFromDatabase();
        startDatabasePolling()
        
    } catch (error) {
        console.error('Signup error:', error);
        errorEl.textContent = 'Error creating account. Please try again.';
        errorEl.style.display = 'block';
    }
}

        function logout() {
            stopActivityTracking();
    stopDatabasePolling(); // CAMBIA cleanupRealtimeSubscriptions() por esto
    appData.currentUser = null;
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('authContainer').classList.remove('hidden');
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    showNotification('Logged out successfully');
}

       async function toggleFollow(username) {
    if (!appData.currentUser || appData.currentUser.isGuest) {
        showNotification('Please create an account to follow users!');
        return;
    }
    
    const user = appData.users.find(u => u.username === username);
    if (!user) return;

    try {
        if (!appData.following[appData.currentUser.username]) {
            appData.following[appData.currentUser.username] = [];
        }

        const followList = appData.following[appData.currentUser.username];
        const isFollowing = followList.includes(username);

        if (isFollowing) {
            await db.unfollowUser(appData.currentUser.id, user.id);
            const index = followList.indexOf(username);
            followList.splice(index, 1);
            user.followers--;
            showNotification('Unfollowed ' + username);
        } else {
            await db.followUser(appData.currentUser.id, user.id);
            followList.push(username);
            user.followers++;
            showNotification('Following ' + username + '!');
        }

        await db.updateUser(user.id, { followers: user.followers });

        if (document.getElementById('profileModal').classList.contains('show')) {
            openUserProfile(username);
        }
    } catch (error) {
        console.error('Error toggling follow:', error);
        showNotification('Error updating follow status');
    }
}

        function isFollowing(username) {
            if (!appData.following[appData.currentUser.username]) {
                return false;
            }
            return appData.following[appData.currentUser.username].includes(username);
        }

        function selectCategory(btn) {
            document.querySelectorAll('.category-option').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            appData.selectedCategory = btn.dataset.category;
        }

        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    appData.currentImage = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function createPost() {
    if (!appData.currentUser) return;
    
    if (appData.currentUser.isGuest) {
        showNotification('Please create an account to post content!');
        return;
    }
    
    const content = document.getElementById('postInput').value.trim();
    
    if (!content) {
        showNotification('Please write something!');
        return;
    }

    try {
        const newPost = await db.createPost({
            author: appData.currentUser.username,
            content,
            category: appData.selectedCategory,
            image: appData.currentImage,
            isRepost: false,
            originalAuthor: null
        });

        appData.posts.unshift({
            id: newPost.id,
            author: newPost.author,
            content: newPost.content,
            category: newPost.category,
            likes: newPost.likes,
            time: 'Just now',
            image: newPost.image,
            isRepost: newPost.is_repost,
            originalAuthor: newPost.original_author
        });

        document.getElementById('postInput').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imageUpload').value = '';
        appData.currentImage = null;
        
        renderPosts();
        showNotification('Post created successfully!');
    } catch (error) {
        console.error('Error creating post:', error);
        showNotification('Error creating post. Please try again.');
    }
}
        function setFilter(filter) {
            appData.currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderPosts();
        }

        async function likePost(postId) {
    if (!appData.currentUser || appData.currentUser.isGuest) {
        showNotification('Please create an account to like posts!');
        return;
    }

    try {
        const liked = await db.toggleLike(appData.currentUser.id, postId);
        const post = appData.posts.find(p => p.id === postId);
        
        if (post) {
            post.likes += liked ? 1 : -1;
            
            if (!appData.likes[appData.currentUser.username]) {
                appData.likes[appData.currentUser.username] = [];
            }
            
            if (liked) {
                appData.likes[appData.currentUser.username].push(postId);
                showNotification('Post liked!');
            } else {
                const index = appData.likes[appData.currentUser.username].indexOf(postId);
                if (index > -1) {
                    appData.likes[appData.currentUser.username].splice(index, 1);
                }
                showNotification('Like removed');
            }
            
            await db.updatePostLikes(postId, post.likes);
        }
        
        renderPosts();
    } catch (error) {
        console.error('Error liking post:', error);
        showNotification('Error updating like');
    }
}

        async function repostPost(postId) {
    if (!appData.currentUser || appData.currentUser.isGuest) {
        showNotification('Please create an account to repost!');
        return;
    }

    const originalPost = appData.posts.find(p => p.id === postId);
    if (!originalPost) return;

    if (originalPost.author === appData.currentUser.username) {
        showNotification('You cannot repost your own post!');
        return;
    }

    const userReposts = appData.reposts[appData.currentUser.username] || [];
    const hasReposted = userReposts.includes(postId);

    if (hasReposted) {
        showNotification('You have already reposted this!');
        return;
    }

    try {
        // Save repost to database
        const newRepost = await db.createPost({
            author: appData.currentUser.username,
            content: originalPost.content,
            category: originalPost.category,
            image: originalPost.image,
            isRepost: true,
            originalAuthor: originalPost.isRepost ? originalPost.originalAuthor : originalPost.author
        });

        // Add to local data
        const repost = {
            id: newRepost.id,
            author: appData.currentUser.username,
            content: newRepost.content,
            category: newRepost.category,
            likes: 0,
            time: 'Just now',
            image: newRepost.image,
            isRepost: true,
            originalAuthor: newRepost.original_author
        };

        if (!appData.reposts[appData.currentUser.username]) {
            appData.reposts[appData.currentUser.username] = [];
        }
        appData.reposts[appData.currentUser.username].push(postId);

        appData.posts.unshift(repost);
        renderPosts();
        showNotification('Post reposted successfully!');
    } catch (error) {
        console.error('Error reposting:', error);
        showNotification('Error reposting. Please try again.');
    }
}

        function toggleComments(postId) {
            const commentsSection = document.getElementById('comments-' + postId);
            if (commentsSection) {
                if (commentsSection.classList.contains('show')) {
                    commentsSection.classList.remove('show');
                    appData.openComments.delete(postId);
                } else {
                    commentsSection.classList.add('show');
                    appData.openComments.add(postId);
                }
            }
        }

        async function addComment(postId) {
    if (!appData.currentUser || appData.currentUser.isGuest) {
        showNotification('Please create an account to comment!');
        return;
    }

    const input = document.getElementById('comment-input-' + postId);
    const content = input.value.trim();

    if (!content) return;

    try {
        const comment = await db.createComment({
            postId: postId,
            author: appData.currentUser.username,
            content: content
        });

        if (!appData.comments[postId]) {
            appData.comments[postId] = [];
        }

        appData.comments[postId].push({
            id: comment.id,
            postId: postId,
            author: comment.author,
            content: comment.content,
            time: 'Just now',
            likes: 0,
            replies: []
        });

        input.value = '';
        renderPosts();
        showNotification('Comment added!');
    } catch (error) {
        console.error('Error adding comment:', error);
        showNotification('Error adding comment');
    }
}

        function likeComment(commentId, postId) {
            const comment = appData.comments[postId].find(c => c.id === commentId);
            if (!comment) return;

            const userLikes = appData.commentLikes[appData.currentUser.username] || [];
            const hasLiked = userLikes.includes(commentId);

            if (hasLiked) {
                const index = userLikes.indexOf(commentId);
                userLikes.splice(index, 1);
                comment.likes = Math.max(0, comment.likes - 1);
            } else {
                if (!appData.commentLikes[appData.currentUser.username]) {
                    appData.commentLikes[appData.currentUser.username] = [];
                }
                appData.commentLikes[appData.currentUser.username].push(commentId);
                comment.likes++;
            }

            renderPosts();
        }

        function toggleReplyForm(commentId) {
            const replyForm = document.getElementById('reply-form-' + commentId);
            if (replyForm) {
                if (replyForm.classList.contains('show')) {
                    replyForm.classList.remove('show');
                    appData.openReplyForms.delete(commentId);
                } else {
                    replyForm.classList.add('show');
                    appData.openReplyForms.add(commentId);
                }
            }
        }

        function addReply(commentId, postId) {
            const input = document.getElementById('reply-input-' + commentId);
            const content = input.value.trim();

            if (!content) return;

            const comment = appData.comments[postId].find(c => c.id === commentId);
            if (!comment) return;

            const reply = {
                id: appData.nextCommentId++,
                author: appData.currentUser.username,
                content: content,
                time: 'Just now',
                likes: 0
            };

            comment.replies.push(reply);
            input.value = '';
            appData.openReplyForms.delete(commentId); // Close the reply form after submitting
            renderPosts();
            showNotification('Reply added!');
        }

        function renderPosts() {
            const container = document.getElementById('postsContainer');
            let filteredPosts = appData.posts;

            if (appData.currentFilter !== 'all') {
                filteredPosts = appData.posts.filter(p => p.category === appData.currentFilter);
            }

            if (filteredPosts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No posts to show. Be the first to post!</p>';
                return;
            }

            container.innerHTML = filteredPosts.map(post => {
                const user = appData.users.find(u => u.username === (post.isRepost ? post.originalAuthor : post.author));
                const reposter = post.isRepost ? appData.users.find(u => u.username === post.author) : null;
                const avatarStyle = user && user.profilePic ? `background-image: url('${user.profilePic}')` : '';
                const hasLiked = appData.currentUser && appData.likes[appData.currentUser.username]?.includes(post.id) || false;
                const hasReposted = appData.currentUser && appData.reposts[appData.currentUser.username]?.includes(post.id) || false;
                const comments = appData.comments[post.id] || [];
                const commentCount = comments.length;
                
                // Fallback values if user not found
                const displayAuthor = user ? user.username : (post.isRepost ? post.originalAuthor : post.author);
                const displayInitials = displayAuthor.substring(0, 2).toUpperCase();

                return `
                <div class="post ${post.isRepost ? 'repost' : ''}">
                    ${post.isRepost ? `
                        <div class="repost-info">
                            üîÑ ${post.author} reposted
                        </div>
                    ` : ''}
                    <div class="post-header" style="position: relative;">
    <div class="avatar" onclick="openUserProfile('${displayAuthor}')" style="${avatarStyle}">${!user || !user.profilePic ? displayInitials : ''}</div>
    <div class="post-info">
        <h4 onclick="openUserProfile('${displayAuthor}')">${displayAuthor}</h4>
        <div class="post-time">${post.time}</div>
    </div>
    ${appData.currentUser && post.author === appData.currentUser.username ? `
        <button class="delete-btn" onclick="deletePost(${post.id})" title="Delete post">üóëÔ∏è</button>
    ` : ''}
</div>
                    </div>
                    <div class="post-content">${post.content}</div>
                    ${post.image ? `<img src="${post.image}" class="post-image" alt="Post image">` : ''}
                    <div class="post-actions">
                        <button class="action-btn ${hasLiked ? 'liked' : ''}" onclick="likePost(${post.id})">‚ù§Ô∏è ${post.likes}</button>
                        <button class="action-btn" onclick="toggleComments(${post.id})">üí¨ ${commentCount} Comment${commentCount !== 1 ? 's' : ''}</button>
                        <button class="action-btn ${hasReposted ? 'reposted' : ''}" onclick="repostPost(${post.id})" ${post.author === (appData.currentUser ? appData.currentUser.username : '') ? 'disabled' : ''}>üîÑ Repost</button>
                    </div>
                    <div class="comments-section ${appData.openComments.has(post.id) ? 'show' : ''}" id="comments-${post.id}">
                        <div class="comment-input">
                            <input type="text" id="comment-input-${post.id}" placeholder="Write a comment..." onkeypress="if(event.key==='Enter') addComment(${post.id})">
                            <button onclick="addComment(${post.id})">Post</button>
                        </div>
                        ${comments.map(comment => {
                            const commentUser = appData.users.find(u => u.username === comment.author);
                            const commentAvatarStyle = commentUser && commentUser.profilePic ? `background-image: url('${commentUser.profilePic}')` : '';
                            const hasLikedComment = appData.currentUser && appData.commentLikes[appData.currentUser.username]?.includes(comment.id) || false;
                            const commentDisplayAuthor = commentUser ? commentUser.username : comment.author;
                            const commentInitials = commentDisplayAuthor.substring(0, 2).toUpperCase();
                            
                            return `
                                <div class="comment">
                                    <div class="comment-header">
                                        <div class="comment-avatar" style="${commentAvatarStyle}">${!commentUser || !commentUser.profilePic ? commentInitials : ''}</div>
                                        <div class="comment-author">${commentDisplayAuthor}</div>
                                        <div class="comment-time">${comment.time}</div>
                                    </div>
                                    <div class="comment-content">${comment.content}</div>
                                    <div class="comment-actions">
    <button class="comment-action ${hasLikedComment ? 'liked' : ''}" onclick="likeComment(${comment.id}, ${post.id})">‚ù§Ô∏è ${comment.likes}</button>
    <button class="comment-action" onclick="toggleReplyForm(${comment.id})">üí¨ Reply</button>
    ${appData.currentUser && comment.author === appData.currentUser.username ? `
        <button class="comment-action delete-btn" onclick="deleteComment(${comment.id}, ${post.id})">üóëÔ∏è Delete</button>
    ` : ''}
</div>
                                    <div class="reply-form ${appData.openReplyForms.has(comment.id) ? 'show' : ''}" id="reply-form-${comment.id}">
                                        <input type="text" id="reply-input-${comment.id}" placeholder="Write a reply..." onkeypress="if(event.key==='Enter') addReply(${comment.id}, ${post.id})">
                                        <button onclick="addReply(${comment.id}, ${post.id})">Reply</button>
                                    </div>
                                    ${comment.replies.length > 0 ? `
                                        <div class="replies">
                                            ${comment.replies.map(reply => {
                                                const replyUser = appData.users.find(u => u.username === reply.author);
                                                const replyAvatarStyle = replyUser && replyUser.profilePic ? `background-image: url('${replyUser.profilePic}')` : '';
                                                const replyDisplayAuthor = replyUser ? replyUser.username : reply.author;
                                                const replyInitials = replyDisplayAuthor.substring(0, 2).toUpperCase();
                                                return `
                                                    <div class="comment">
                                                        <div class="comment-header">
                                                            <div class="comment-avatar" style="${replyAvatarStyle}">${!replyUser || !replyUser.profilePic ? replyInitials : ''}</div>
                                                            <div class="comment-author">${replyDisplayAuthor}</div>
                                                            <div class="comment-time">${reply.time}</div>
                                                        </div>
                                                        <div class="comment-content">${reply.content}</div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `}).join('');
        }

        function performSearch(query) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!query.trim()) {
                resultsContainer.classList.remove('show');
                return;
            }

            const searchUsers = appData.users.filter(u => 
                u.username.toLowerCase().includes(query.toLowerCase()) ||
                u.bio.toLowerCase().includes(query.toLowerCase())
            );

            const searchPosts = appData.posts.filter(p => 
                p.content.toLowerCase().includes(query.toLowerCase())
            );

            let html = '';

            if (searchUsers.length > 0) {
                html += '<div class="search-section-title">Users</div>';
                html += searchUsers.map(user => {
                    const avatarStyle = user.profilePic ? `background-image: url('${user.profilePic}')` : '';
                    return `
                    <div class="search-result-item" onclick="openUserProfile('${user.username}')">
                        <div class="search-user">
                            <div class="search-user-avatar" style="${avatarStyle}">${!user.profilePic ? user.username.substring(0, 2).toUpperCase() : ''}</div>
                            <div class="search-user-info">
                                <div class="search-user-name">${user.username}</div>
                                <div class="search-user-bio">${user.bio}</div>
                            </div>
                        </div>
                    </div>
                `}).join('');
            }

            if (searchPosts.length > 0) {
                html += '<div class="search-section-title">Posts</div>';
                html += searchPosts.slice(0, 3).map(post => `
                    <div class="search-result-item">
                        <div class="search-post">
                            <div class="search-post-author">${post.author}</div>
                            ${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}
                        </div>
                    </div>
                `).join('');
            }

            if (html) {
                resultsContainer.innerHTML = html;
                resultsContainer.classList.add('show');
            } else {
                resultsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No results found</div>';
                resultsContainer.classList.add('show');
            }
        }

        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                document.getElementById('searchResults').classList.remove('show');
            }
        });

        function openUserProfile(username) {
            const user = appData.users.find(u => u.username === username);
            if (!user) return;
            
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileContent');
            
            const userPosts = appData.posts.filter(p => p.author === username && !p.isRepost);
            const userReposts = appData.posts.filter(p => p.author === username && p.isRepost);
            const isOwnProfile = appData.currentUser.username === username;
            const following = isFollowing(username);
            
            const avatarStyle = user.profilePic ? `background-image: url('${user.profilePic}')` : '';
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="profile-pic-large" style="${avatarStyle}">
                        ${!user.profilePic ? user.username.substring(0, 2).toUpperCase() : ''}
                    </div>
                    <h3 style="color: #1e3c72; margin-bottom: 5px; font-size: 24px;">${user.username}</h3>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">${user.email}</p>
                    ${!isOwnProfile ? `
                        <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                            <button class="auth-btn follow-btn ${following ? 'following' : ''}" onclick="toggleFollow('${user.username}')">
                                ${following ? '‚úì Following' : '+ Follow'}
                            </button>
                            <button class="message-btn" onclick="openChatWith('${user.username}')">
                                üí¨ Message
                            </button>
                        </div>
                    ` : ''}
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #1e3c72; display: block; margin-bottom: 10px;">Bio</strong>
                    <p style="line-height: 1.6; color: #333;">${user.bio}</p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: white;">${userPosts.length}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">Posts</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: white;">${user.followers}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">Followers</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: white;">${appData.following[user.username] ? appData.following[user.username].length : 0}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">Following</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 28px; font-weight: bold; color: white;">${userReposts.length}</div>
                        <div style="font-size: 13px; color: rgba(255,255,255,0.9); margin-top: 5px;">Reposts</div>
                    </div>
                </div>
                ${userPosts.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #1e3c72; margin-bottom: 15px; font-size: 18px;">Recent Posts</h4>
                        ${userPosts.slice(0, 3).map(post => `
                            <div style="background: white; border: 2px solid #f0f0f0; border-radius: 12px; padding: 15px; margin-bottom: 12px;">
                                <div style="color: #666; font-size: 12px; margin-bottom: 8px;">${post.time}</div>
                                <div style="line-height: 1.6; color: #333; margin-bottom: 10px;">${post.content}</div>
                                ${post.image ? `<img src="${post.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;" alt="Post image">` : ''}
                                <div style="color: #666; font-size: 13px;">‚ù§Ô∏è ${post.likes} likes</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                ${userReposts.length > 0 ? `
                    <div>
                        <h4 style="color: #1e3c72; margin-bottom: 15px; font-size: 18px;">Recent Reposts</h4>
                        ${userReposts.slice(0, 3).map(post => `
                            <div style="background: white; border: 2px solid #e8f5e8; border-left: 4px solid #4caf50; border-radius: 12px; padding: 15px; margin-bottom: 12px;">
                                <div style="color: #4caf50; font-size: 11px; margin-bottom: 5px;">üîÑ Reposted from ${post.originalAuthor}</div>
                                <div style="color: #666; font-size: 12px; margin-bottom: 8px;">${post.time}</div>
                                <div style="line-height: 1.6; color: #333; margin-bottom: 10px;">${post.content}</div>
                                ${post.image ? `<img src="${post.image}" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;" alt="Post image">` : ''}
                                <div style="color: #666; font-size: 13px;">‚ù§Ô∏è ${post.likes} likes</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                ${userPosts.length === 0 && userReposts.length === 0 ? `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìù</div>
                        <p>No posts yet</p>
                    </div>
                ` : ''}
            `;
            
            modal.classList.add('show');
            document.getElementById('searchResults').classList.remove('show');
        }

        function openProfile() {
            if (!appData.currentUser) return;
            
            if (appData.currentUser.isGuest) {
                showGuestProfilePrompt();
                return;
            }
            
            openUserProfile(appData.currentUser.username);
        }

        function showGuestProfilePrompt() {
            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileContent');
            
            content.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üë§</div>
                    <h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 24px;">Create Your Profile</h3>
                    <p style="color: #666; font-size: 16px; margin-bottom: 30px; line-height: 1.5;">
                        To create a profile, follow other users, and share your own aviation and motorsport experiences, you'll need to create an account.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="auth-btn" onclick="showSignupFromGuest()" style="width: auto; padding: 12px 30px;">
                            Create Account
                        </button>
                        <button class="auth-btn" onclick="showLoginFromGuest()" style="width: auto; padding: 12px 30px; background: linear-gradient(45deg, #666, #888);">
                            Sign In
                        </button>
                    </div>
                    <div style="margin-top: 20px;">
                        <button onclick="closeModal('profileModal')" style="background: none; border: none; color: #666; cursor: pointer; text-decoration: underline;">
                            Continue browsing as guest
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function showSignupFromGuest() {
            closeModal('profileModal');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authContainer').classList.remove('hidden');
            showSignup();
        }

        function showLoginFromGuest() {
            closeModal('profileModal');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authContainer').classList.remove('hidden');
            showLogin();
        }

        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const content = document.getElementById('settingsContent');
            
            const avatarStyle = appData.currentUser.profilePic ? `background-image: url('${appData.currentUser.profilePic}')` : '';
            
            content.innerHTML = `
                <div class="settings-section">
                    <h4>Profile Picture</h4>
                    <div class="profile-pic-container">
                        <div class="profile-pic-large" id="settingsProfilePic" style="${avatarStyle}">
                            ${!appData.currentUser.profilePic ? appData.currentUser.username.substring(0, 2).toUpperCase() : ''}
                        </div>
                        <label class="auth-btn" style="width: auto; display: inline-block; cursor: pointer;">
                            üì∑ Upload Profile Picture
                            <input type="file" id="profilePicUpload" accept="image/*" style="display: none;" onchange="uploadProfilePic(this)">
                        </label>
                        ${appData.currentUser.profilePic ? `
                            <button class="auth-btn" style="width: auto; display: inline-block; background: #e53935; margin-left: 10px;" onclick="removeProfilePic()">
                                üóëÔ∏è Remove Picture
                            </button>
                        ` : ''}
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Account Information</h4>
                    <div class="setting-item">
                        <label class="setting-label">Username</label>
                        <input type="text" class="auth-input" id="settingsUsername" value="${appData.currentUser.username}" style="margin-bottom: 0;">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Email</label>
                        <input type="email" class="auth-input" id="settingsEmail" value="${appData.currentUser.email}" style="margin-bottom: 0;">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Bio</label>
                        <textarea class="auth-input" id="settingsBio" style="min-height: 80px; resize: vertical; margin-bottom: 0;">${appData.currentUser.bio}</textarea>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Change Password</h4>
                    <div class="setting-item">
                        <label class="setting-label">New Password</label>
                        <input type="password" class="auth-input" id="settingsNewPassword" placeholder="Leave blank to keep current password" style="margin-bottom: 0;">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Confirm New Password</label>
                        <input type="password" class="auth-input" id="settingsConfirmPassword" placeholder="Confirm new password" style="margin-bottom: 0;">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button class="auth-btn" style="width: auto; background: #666;" onclick="closeModal('settingsModal')">Cancel</button>
                    <button class="auth-btn" style="width: auto;" onclick="saveSettings()">Save Changes</button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function uploadProfilePic(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            appData.currentUser.profilePic = e.target.result;
            document.getElementById('settingsProfilePic').style.backgroundImage = `url('${e.target.result}')`;
            document.getElementById('settingsProfilePic').textContent = '';
            showNotification('Profile picture updated! Click Save Changes to confirm.');
        };
        reader.readAsDataURL(input.files[0]);
    }

}

        function removeProfilePic() {
    appData.currentUser.profilePic = null;
    const picEl = document.getElementById('settingsProfilePic');
    picEl.style.backgroundImage = '';
    picEl.textContent = appData.currentUser.username.substring(0, 2).toUpperCase();
    openSettings();
    showNotification('Profile picture removed! Click Save Changes to confirm.');
}
        async function saveSettings() {
    const newUsername = document.getElementById('settingsUsername').value.trim();
    const newEmail = document.getElementById('settingsEmail').value.trim();
    const newBio = document.getElementById('settingsBio').value.trim();
    const newPassword = document.getElementById('settingsNewPassword').value;
    const confirmPassword = document.getElementById('settingsConfirmPassword').value;

    if (!newUsername || !newEmail) {
        showNotification('Username and email are required!');
        return;
    }

    if (newPassword && newPassword !== confirmPassword) {
        showNotification('Passwords do not match!');
        return;
    }

    try {
        const existingUser = await db.getUserByUsername(newUsername);
        if (existingUser && existingUser.id !== appData.currentUser.id) {
            showNotification('Username already taken!');
            return;
        }

        const oldUsername = appData.currentUser.username;
        
        // Prepare update object
        const updates = {
            username: newUsername,
            email: newEmail,
            bio: newBio,
            profile_pic: appData.currentUser.profilePic
        };
        
        if (newPassword) {
            updates.password = newPassword;
        }

        // Update in database
        await db.updateUser(appData.currentUser.id, updates);

        // Update local data
        appData.currentUser.username = newUsername;
        appData.currentUser.email = newEmail;
        appData.currentUser.bio = newBio;
        
        if (newPassword) {
            appData.currentUser.password = newPassword;
        }

        // Update username in posts
        appData.posts.forEach(post => {
            if (post.author === oldUsername) {
                post.author = newUsername;
            }
            if (post.originalAuthor === oldUsername) {
                post.originalAuthor = newUsername;
            }
        });

        // Update username in comments
        Object.keys(appData.comments).forEach(postId => {
            appData.comments[postId].forEach(comment => {
                if (comment.author === oldUsername) {
                    comment.author = newUsername;
                }
                comment.replies.forEach(reply => {
                    if (reply.author === oldUsername) {
                        reply.author = newUsername;
                    }
                });
            });
        });

        // Update in users array
        const userIndex = appData.users.findIndex(u => u.id === appData.currentUser.id);
        if (userIndex !== -1) {
            appData.users[userIndex] = {...appData.currentUser};
        }

        closeModal('settingsModal');
        showNotification('Settings saved successfully!');
        renderPosts();
    } catch (error) {
        console.error('Error saving settings:', error);
        showNotification('Error saving settings. Please try again.');
    }
}
        async function openMessages() {
    const modal = document.getElementById('messagesModal');
    const contactsList = document.getElementById('contactsList');
    
    const otherUsers = appData.users.filter(u => u.username !== appData.currentUser.username);
    
    if (otherUsers.length === 0) {
        contactsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No contacts available</p>';
    } else {
        // Get all last seen times
        const usersWithStatus = await Promise.all(
            otherUsers.map(async (user) => {
                const lastSeen = await db.getUserLastSeen(user.username);
                const statusInfo = getOnlineStatus(lastSeen);
                return { ...user, statusInfo };
            })
        );
        
        contactsList.innerHTML = '<h4 style="color: #1e3c72; margin-bottom: 10px;">Contacts</h4>' + 
            usersWithStatus.map(user => {
                const avatarStyle = user.profilePic ? `background-image: url('${user.profilePic}')` : '';
                return `
                <div class="contact-item" onclick="openChatWith('${user.username}')">
                    <div class="contact-avatar" style="${avatarStyle}; position: relative;">
                        ${!user.profilePic ? user.username.substring(0, 2).toUpperCase() : ''}
                        <span style="position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; border-radius: 50%; background: ${user.statusInfo.color}; border: 2px solid white;"></span>
                    </div>
                    <div>
                        <div class="contact-name">${user.username}</div>
                        <div style="font-size: 10px; color: ${user.statusInfo.color};">${user.statusInfo.text}</div>
                    </div>
                </div>
            `}).join('');
    }
    
    document.getElementById('chatArea').style.display = 'none';
    modal.classList.add('show');
}

        async function openChatWith(username) {
    appData.currentChat = username;
    const user = appData.users.find(u => u.username === username);
    if (!user) return;

    if (!appData.messages[appData.currentUser.username]) {
        appData.messages[appData.currentUser.username] = {};
    }
    if (!appData.messages[appData.currentUser.username][username]) {
        appData.messages[appData.currentUser.username][username] = [];
    }

    const avatarStyle = user.profilePic ? `background-image: url('${user.profilePic}')` : '';
    
    // Get real-time online status
    const lastSeen = await db.getUserLastSeen(username);
    const statusInfo = getOnlineStatus(lastSeen);
    
    document.getElementById('chatHeader').innerHTML = `
        <div class="contact-avatar" style="${avatarStyle}">
            ${!user.profilePic ? user.username.substring(0, 2).toUpperCase() : ''}
        </div>
        <div>
            <div style="font-weight: bold; color: #1e3c72;">${user.username}</div>
            <div style="font-size: 11px; color: ${statusInfo.color}; display: flex; align-items: center; gap: 4px;">
                <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${statusInfo.color};"></span>
                ${statusInfo.text}
            </div>
        </div>
    `;

    renderChatMessages();
    document.getElementById('chatArea').style.display = 'flex';
    document.getElementById('messagesModal').classList.add('show');
    
    closeModal('profileModal');
    updateMessageBadge();
}

        function renderChatMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            const messages = appData.messages[appData.currentUser.username]?.[appData.currentChat] || [];
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = '<p style="text-align: center; color: #999;">No messages yet. Start the conversation!</p>';
            } else {
                messagesContainer.innerHTML = messages.map(msg => `
                    <div class="message ${msg.sender === appData.currentUser.username ? 'sent' : 'received'}">
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${msg.time}</div>
                    </div>
                `).join('');
            }
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

      async function sendMessage() {
    if (!appData.currentUser || appData.currentUser.isGuest) {
        showNotification('Please create an account to send messages!');
        return;
    }

    const input = document.getElementById('chatInput');
    const content = input.value.trim();
    
    if (!content || !appData.currentChat) return;

    const receiver = appData.users.find(u => u.username === appData.currentChat);
    if (!receiver) return;

    // Disable input to prevent double-sending
    input.disabled = true;

    try {
        const newMessage = await db.sendMessage({
            senderId: appData.currentUser.id,
            receiverId: receiver.id,
            content: content
        });

        // Add message locally with database ID
        const message = {
            id: newMessage.id,
            sender: appData.currentUser.username,
            content: content,
            time: formatTimeAgo(newMessage.created_at),
            timestamp: new Date(newMessage.created_at).getTime()
        };

        if (!appData.messages[appData.currentUser.username]) {
            appData.messages[appData.currentUser.username] = {};
        }
        if (!appData.messages[appData.currentUser.username][appData.currentChat]) {
            appData.messages[appData.currentUser.username][appData.currentChat] = [];
        }
        
        // Check if message already exists (prevent duplicates)
        const exists = appData.messages[appData.currentUser.username][appData.currentChat]
            .some(m => m.id === newMessage.id);
        
        if (!exists) {
            appData.messages[appData.currentUser.username][appData.currentChat].push(message);
        }

        input.value = '';
        renderChatMessages();
        updateMessageBadge();
    } catch (error) {
        console.error('Error sending message:', error);
        showNotification('Error sending message');
    } finally {
        input.disabled = false;
        input.focus();
    }
}
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        function dismissNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function openLiveEvent(eventId) {
            const liveEvents = {
                'singapore-gp': {
                    title: 'Singapore GP Practice 2',
                    description: 'Formula 1 Singapore Grand Prix Practice Session',
                    streamUrl: 'https://www.formula1.com/en/racing/2024/singapore/live-timing.html',
                    alternativeUrl: 'https://www.youtube.com/results?search_query=singapore+gp+live+stream'
                },
                'oshkosh-airventure': {
                    title: 'Oshkosh AirVenture',
                    description: 'The World\'s Greatest Aviation Celebration',
                    streamUrl: 'https://www.eaa.org/airventure/live-video-streaming',
                    alternativeUrl: 'https://www.youtube.com/results?search_query=oshkosh+airventure+live+stream'
                },
                'lemans-24h': {
                    title: 'Le Mans 24 Hours',
                    description: '24 Hours of Le Mans Endurance Race',
                    streamUrl: 'https://www.24h-lemans.com/en/live',
                    alternativeUrl: 'https://www.youtube.com/results?search_query=le+mans+24+hours+live+stream'
                }
            };

            const event = liveEvents[eventId];
            if (!event) return;

            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileContent');
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üî¥</div>
                    <h3 style="color: #1e3c72; margin-bottom: 10px; font-size: 24px;">${event.title}</h3>
                    <p style="color: #666; font-size: 16px; margin-bottom: 20px;">${event.description}</p>
                    <div style="background: linear-gradient(135deg, #e53935 0%, #c62828 100%); color: white; padding: 8px 20px; border-radius: 20px; display: inline-block; margin-bottom: 20px; font-weight: bold;">
                        üî¥ LIVE NOW
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #1e3c72; margin-bottom: 15px;">üé• Watch Live Stream</h4>
                    <p style="color: #666; margin-bottom: 15px; line-height: 1.5;">
                        Click the buttons below to access live streams and coverage of this event.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <button class="auth-btn" onclick="window.open('${event.streamUrl}', '_blank')" style="width: auto; padding: 12px 20px;">
                            üì∫ Official Stream
                        </button>
                        <button class="auth-btn" onclick="window.open('${event.alternativeUrl}', '_blank')" style="width: auto; padding: 12px 20px; background: linear-gradient(45deg, #ff0000, #cc0000);">
                            üì± YouTube Search
                        </button>
                    </div>
                </div>

                <div style="background: #fff3e0; padding: 20px; border-radius: 12px; border-left: 4px solid #ff9800;">
                    <h4 style="color: #ef6c00; margin-bottom: 10px;">üìã Event Details</h4>
                    <div style="color: #666; line-height: 1.6;">
                        ${eventId === 'singapore-gp' ? `
                            <p><strong>Track:</strong> Marina Bay Street Circuit</p>
                            <p><strong>Session:</strong> Practice 2</p>
                            <p><strong>Duration:</strong> 90 minutes</p>
                            <p><strong>Next:</strong> Qualifying Session</p>
                        ` : eventId === 'oshkosh-airventure' ? `
                            <p><strong>Location:</strong> Wittman Regional Airport, Wisconsin</p>
                            <p><strong>Duration:</strong> 7 days</p>
                            <p><strong>Aircraft:</strong> Over 10,000 aircraft expected</p>
                            <p><strong>Attendees:</strong> 650,000+ aviation enthusiasts</p>
                        ` : `
                            <p><strong>Circuit:</strong> Circuit de la Sarthe, France</p>
                            <p><strong>Distance:</strong> 13.626 km per lap</p>
                            <p><strong>Duration:</strong> 24 hours of non-stop racing</p>
                            <p><strong>Teams:</strong> 62 teams competing</p>
                        `}
                    </div>
                </div>
            `;
            
            document.querySelector('.modal-title').textContent = 'Live Event';
            modal.classList.add('show');
        }

        function openTrendingTopic(topicId) {
            const trendingTopics = {
                'F1Singapore': {
                    hashtag: '#F1Singapore',
                    title: 'Singapore Grand Prix',
                    category: 'Formula 1',
                    posts: 45200,
                    description: 'The Singapore Grand Prix is heating up with intense qualifying sessions and street circuit drama.',
                    keyPoints: [
                        'Marina Bay Street Circuit provides unique night racing experience',
                        'Max Verstappen currently leads championship standings',
                        'Street circuit challenges test driver skill and precision',
                        'High-profile celebrity attendance and glamorous atmosphere',
                        'Humidity and heat add physical challenge for drivers',
                        'Track evolution throughout weekend affects strategy'
                    ],
                    recentNews: [
                        'Qualifying results show tight competition in top 10',
                        'Weather conditions expected to remain stable',
                        'New track surface improvements completed',
                        'Record attendance expected for race weekend'
                    ],
                    relatedHashtags: ['#Formula1', '#SingaporeGP', '#F1Night', '#MarinaBay']
                },
                'Boeing737MAX': {
                    hashtag: '#Boeing737MAX',
                    title: 'Boeing 737 MAX Updates',
                    category: 'Aviation',
                    posts: 23800,
                    description: 'Latest developments and safety improvements in the Boeing 737 MAX aircraft series continue to shape aviation industry discussions.',
                    keyPoints: [
                        'Continued safety monitoring and comprehensive improvements',
                        'Airlines reporting positive operational experience and reliability',
                        'New software updates enhance flight control systems',
                        'Passenger confidence steadily recovering worldwide',
                        'Training programs updated for pilots and maintenance crews',
                        'Regulatory oversight remains strict across all markets'
                    ],
                    recentNews: [
                        'Latest software update improves system redundancy',
                        'Major airlines expand 737 MAX fleet operations',
                        'Safety statistics show positive operational trends',
                        'New orders indicate industry confidence recovery'
                    ],
                    relatedHashtags: ['#Boeing', '#Aviation', '#AirSafety', '#737MAX']
                },
                'WEC2025': {
                    hashtag: '#WEC2025',
                    title: 'World Endurance Championship 2025',
                    category: 'Motorsport',
                    posts: 18700,
                    description: 'The 2025 WEC season brings revolutionary regulations, manufacturer competition, and cutting-edge endurance racing technology.',
                    keyPoints: [
                        'New Hypercar regulations attract major manufacturers',
                        'Toyota, Porsche, Ferrari, and Peugeot lead fierce competition',
                        'Le Mans 24 Hours remains the ultimate endurance challenge',
                        'Increased focus on sustainable fuel technology development',
                        'Driver lineups feature mix of experience and young talent',
                        'Global championship visits iconic circuits worldwide'
                    ],
                    recentNews: [
                        'New manufacturer entries announced for mid-season',
                        'Sustainable fuel initiatives show promising results',
                        'Driver market sees major moves between teams',
                        'Calendar expansion includes new international venues'
                    ],
                    relatedHashtags: ['#WEC', '#LeMans', '#Endurance', '#Hypercar']
                },
                'AirbusA350': {
                    hashtag: '#AirbusA350',
                    title: 'Airbus A350 Developments',
                    category: 'Aviation',
                    posts: 31200,
                    description: 'The A350 continues revolutionizing long-haul aviation with industry-leading efficiency and unmatched passenger comfort.',
                    keyPoints: [
                        'Fuel efficiency sets new industry standards',
                        'Passenger comfort enhanced with larger windows and cabin space',
                        'Advanced composite materials significantly reduce aircraft weight',
                        'Growing popularity with major airlines worldwide',
                        'Range capabilities enable new direct route possibilities',
                        'Maintenance costs lower than previous generation aircraft'
                    ],
                    recentNews: [
                        'New variant announced with extended range capabilities',
                        'Major airline orders boost production schedule',
                        'Cabin innovations improve passenger experience',
                        'Environmental impact studies show significant improvements'
                    ],
                    relatedHashtags: ['#Airbus', '#A350', '#Aviation', '#LongHaul']
                },
                'FormulaE': {
                    hashtag: '#FormulaE',
                    title: 'Formula E Championship',
                    category: 'Electric Racing',
                    posts: 19500,
                    description: 'Electric racing continues expanding with innovative technology, sustainable motorsport practices, and growing global fanbase.',
                    keyPoints: [
                        'All-electric racing pushes automotive technology boundaries',
                        'Street circuits bring exciting racing to major city centers',
                        'Manufacturers developing advanced road car technology',
                        'Growing fanbase embraces sustainable racing future',
                        'Attack Mode and Fan Boost add strategic elements',
                        'Young demographic engagement through digital platforms'
                    ],
                    recentNews: [
                        'New manufacturers join championship for next season',
                        'Battery technology improvements extend race distances',
                        'Calendar expansion includes new city venues',
                        'Partnership with automotive industry strengthens'
                    ],
                    relatedHashtags: ['#FormulaE', '#Electric', '#Sustainable', '#StreetRacing']
                }
            };

            const topic = trendingTopics[topicId];
            if (!topic) return;

            // Find related posts that contain the hashtag
            const relatedPosts = appData.posts.filter(post => 
                post.content.toLowerCase().includes(topic.hashtag.toLowerCase()) ||
                topic.relatedHashtags.some(tag => post.content.toLowerCase().includes(tag.toLowerCase()))
            );

            const modal = document.getElementById('profileModal');
            const content = document.getElementById('profileContent');
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìà</div>
                    <h3 style="color: #1e3c72; margin-bottom: 10px; font-size: 28px;">${topic.hashtag}</h3>
                    <p style="color: #666; font-size: 18px; margin-bottom: 10px;">${topic.title}</p>
                    <div style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white; padding: 8px 16px; border-radius: 15px; display: inline-block; margin-bottom: 20px; font-size: 14px; font-weight: bold;">
                        ${topic.category}
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                        <div style="font-size: 20px; font-weight: bold;">${topic.posts.toLocaleString()}</div>
                        <div style="font-size: 11px; margin-top: 5px; opacity: 0.9;">Total Posts</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                        <div style="font-size: 20px; font-weight: bold;">#${Math.floor(Math.random() * 10) + 1}</div>
                        <div style="font-size: 11px; margin-top: 5px; opacity: 0.9;">Trending Rank</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%); padding: 20px; border-radius: 12px; text-align: center; color: white;">
                        <div style="font-size: 20px; font-weight: bold;">${relatedPosts.length}</div>
                        <div style="font-size: 11px; margin-top: 5px; opacity: 0.9;">Posts Here</div>
                    </div>
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #1e3c72; margin-bottom: 15px;">üìù What's Happening</h4>
                    <p style="color: #333; line-height: 1.6; margin-bottom: 15px;">${topic.description}</p>
                </div>

                <div style="background: #fff; border: 2px solid #e3f2fd; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #1e3c72; margin-bottom: 15px;">üîç Key Discussion Points</h4>
                    <ul style="color: #666; line-height: 1.6; padding-left: 20px; margin: 0;">
                        ${topic.keyPoints.map(point => `<li style="margin-bottom: 8px;">${point}</li>`).join('')}
                    </ul>
                </div>

                <div style="background: #fff8e1; border: 2px solid #ffcc02; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #f57f17; margin-bottom: 15px;">üì∞ Recent Developments</h4>
                    <ul style="color: #f57f17; line-height: 1.6; padding-left: 20px; margin: 0;">
                        ${topic.recentNews.map(news => `<li style="margin-bottom: 8px;">${news}</li>`).join('')}
                    </ul>
                </div>

                <div style="background: #f3e5f5; border: 2px solid #9c27b0; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4 style="color: #7b1fa2; margin-bottom: 15px;">üè∑Ô∏è Related Hashtags</h4>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${topic.relatedHashtags.map(tag => `
                            <span style="background: linear-gradient(135deg, #9c27b0, #ba68c8); color: white; padding: 6px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; cursor: pointer;" onclick="searchHashtag('${tag}')">
                                ${tag}
                            </span>
                        `).join('')}
                    </div>
                </div>

                ${relatedPosts.length > 0 ? `
                    <div style="background: #e8f5e8; border: 2px solid #4caf50; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4 style="color: #2e7d32; margin-bottom: 15px;">üí¨ Related Posts (${relatedPosts.length})</h4>
                        ${relatedPosts.slice(0, 3).map(post => {
                            const user = appData.users.find(u => u.username === post.author);
                            return `
                                <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid #4caf50;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <div style="width: 24px; height: 24px; border-radius: 50%; background: linear-gradient(45deg, #ff6b35, #1e3c72); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px;">
                                            ${user ? user.username.substring(0, 2).toUpperCase() : post.author.substring(0, 2).toUpperCase()}
                                        </div>
                                        <div style="font-weight: bold; color: #1e3c72; font-size: 13px;">${post.author}</div>
                                        <div style="color: #999; font-size: 11px;">${post.time}</div>
                                    </div>
                                    <div style="color: #333; font-size: 14px; line-height: 1.4; margin-bottom: 8px;">
                                        ${post.content.length > 150 ? post.content.substring(0, 150) + '...' : post.content}
                                    </div>
                                    <div style="color: #666; font-size: 12px;">‚ù§Ô∏è ${post.likes} likes</div>
                                </div>
                            `;
                        }).join('')}
                        ${relatedPosts.length > 3 ? `
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="searchHashtag('${topic.hashtag}')" style="background: #4caf50; color: white; border: none; padding: 8px 16px; border-radius: 15px; font-size: 12px; cursor: pointer;">
                                    View all ${relatedPosts.length} posts
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : `
                    <div style="background: #fff3e0; border: 2px solid #ff9800; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üìù</div>
                        <h4 style="color: #ef6c00; margin-bottom: 10px;">No Related Posts Yet</h4>
                        <p style="color: #f57c00; font-size: 14px; margin-bottom: 15px;">Be the first to post about ${topic.hashtag}!</p>
                        <button class="auth-btn" onclick="closeModal('profileModal'); createHashtagPost('${topic.hashtag}');" style="width: auto; padding: 10px 20px; background: linear-gradient(45deg, #ff9800, #ffb74d); font-size: 14px;">
                            Create Post
                        </button>
                    </div>
                `}

                <div style="background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%); padding: 20px; border-radius: 12px; border-left: 4px solid #4caf50;">
                    <h4 style="color: #2e7d32; margin-bottom: 15px;">üí¨ Join the Conversation</h4>
                    <p style="color: #558b2f; line-height: 1.6; margin-bottom: 15px;">
                        Share your thoughts about ${topic.title}! Use ${topic.hashtag} in your posts to join thousands of other enthusiasts in the discussion.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="auth-btn" onclick="closeModal('profileModal'); createHashtagPost('${topic.hashtag}');" style="width: auto; padding: 12px 20px; background: linear-gradient(45deg, #4caf50, #66bb6a);">
                            üìù Create Post
                        </button>
                        <button class="auth-btn" onclick="searchHashtag('${topic.hashtag}')" style="width: auto; padding: 12px 20px; background: linear-gradient(45deg, #2196f3, #42a5f5);">
                            üîç Search Posts
                        </button>
                    </div>
                </div>
            `;
            
            document.querySelector('.modal-title').textContent = 'Trending Topic';
            modal.classList.add('show');
        }

        function searchHashtag(hashtag) {
            closeModal('profileModal');
            document.getElementById('searchInput').value = hashtag;
            performSearch(hashtag);
            showNotification(`Searching for ${hashtag}...`);
        }

        function createHashtagPost(hashtag) {
            const postInput = document.getElementById('postInput');
            postInput.value = `${hashtag} `;
            postInput.focus();
            // Move cursor to end
            postInput.setSelectionRange(postInput.value.length, postInput.value.length);
            showNotification(`Ready to post about ${hashtag}!`);
        }
async function deletePost(postId) {
            if (!appData.currentUser || appData.currentUser.isGuest) {
                showNotification('Please create an account to delete posts!');
                return;
            }

            const post = appData.posts.find(p => p.id === postId);
            if (!post) return;

            if (post.author !== appData.currentUser.username) {
                showNotification('You can only delete your own posts!');
                return;
            }

            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('posts')
                    .delete()
                    .eq('id', postId);

                if (error) throw error;

                appData.posts = appData.posts.filter(p => p.id !== postId);
                delete appData.comments[postId];
                renderPosts();
                showNotification('Post deleted successfully!');
            } catch (error) {
                console.error('Error deleting post:', error);
                showNotification('Error deleting post');
            }
        }

        async function deleteComment(commentId, postId) {
            if (!appData.currentUser || appData.currentUser.isGuest) {
                showNotification('Please create an account to delete comments!');
                return;
            }

            const comment = appData.comments[postId]?.find(c => c.id === commentId);
            if (!comment) return;

            if (comment.author !== appData.currentUser.username) {
                showNotification('You can only delete your own comments!');
                return;
            }

            if (!confirm('Are you sure you want to delete this comment?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('comments')
                    .delete()
                    .eq('id', commentId);

                if (error) throw error;

                appData.comments[postId] = appData.comments[postId].filter(c => c.id !== commentId);
                renderPosts();
                showNotification('Comment deleted successfully!');
            } catch (error) {
                console.error('Error deleting comment:', error);
                showNotification('Error deleting comment');
            }
        }

        initSampleData();
        loadDataFromDatabase();
        
    </script>
        
</body>
</html>